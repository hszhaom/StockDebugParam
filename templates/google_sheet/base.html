<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Google Sheet 参数批量校验{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            font-family: 'Courier New', monospace;
            border-radius: 0.375rem;
            font-size: 0.9em;
        }
        .parameter-input {
            min-height: 100px;
        }
        .combination-preview {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('google_sheet.index') }}">
                <i class="bi bi-table"></i> Google Sheet 参数批量校验
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'google_sheet.index' %}active{% endif %}" 
                           href="{{ url_for('google_sheet.index') }}">
                            <i class="bi bi-house"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'google_sheet.create' %}active{% endif %}" 
                           href="{{ url_for('google_sheet.create') }}">
                            <i class="bi bi-plus-circle"></i> 创建任务
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin.dashboard') }}">
                            <i class="bi bi-gear"></i> 管理面板
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <script>
        // 通用AJAX函数
        function ajaxRequest(url, method, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, url, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status === 200) {
                            callback(null, response);
                        } else {
                            // 非200状态码，但有JSON响应，传递响应数据
                            callback(new Error(`HTTP ${xhr.status}`), response);
                        }
                    } catch (e) {
                        // JSON解析失败
                        callback(new Error(`Request failed: ${xhr.status} ${xhr.statusText}`), null);
                    }
                }
            };
            xhr.send(data ? JSON.stringify(data) : null);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 插入到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        // 获取任务状态文本
        function getStatusText(status) {
            switch (status) {
                case 'pending': return '待执行';
                case 'running': return '执行中';
                case 'completed': return '已完成';
                case 'cancelled': return '已取消';
                case 'error': return '执行出错';
                default: return status;
            }
        }

        // 获取任务状态类
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'badge bg-secondary';
                case 'running': return 'badge bg-warning';
                case 'completed': return 'badge bg-success';
                case 'cancelled': return 'badge bg-info';
                case 'error': return 'badge bg-danger';
                default: return 'badge bg-secondary';
            }
        }

        // 解析JSON数组
        function parseJsonArray(text) {
            try {
                if (!text.trim()) {
                    return [];
                }
                return JSON.parse(text);
            } catch (e) {
                return null;
            }
        }

        // 从URL中提取Spreadsheet ID
        function extractSpreadsheetId(url) {
            const regex = /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
            const match = url.match(regex);
            if (match && match[1]) {
                return match[1];
            }
            return url;
        }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
