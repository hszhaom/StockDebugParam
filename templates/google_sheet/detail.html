{% extends "google_sheet/base.html" %}

{% block title %}任务详情 - Google Sheet 参数批量校验{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- 任务概览卡片 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> 任务概览
                </h4>
                <div class="btn-group" role="group">
                    <button class="btn btn-warning btn-sm" id="cancel-task-btn" style="display:none;">
                        <i class="bi bi-stop-circle"></i> 停止任务
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="restart-dropdown-btn" style="display:none;">
                            <i class="bi bi-arrow-clockwise"></i> 重启任务
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="restartTask(true)">
                                <i class="bi bi-play-circle"></i> 从断点重启
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="restartTask(false)">
                                <i class="bi bi-arrow-repeat"></i> 从头重启
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="goToCreateRestartTask()">
                                <i class="bi bi-plus-circle"></i> 跳转到创建重启任务
                            </a></li>
                        </ul>
                    </div>
                    <button class="btn btn-outline-info btn-sm" id="check-status-btn" onclick="checkTaskStatus()">
                        <i class="bi bi-search"></i> 检查状态
                    </button>
                    <a href="{{ url_for('google_sheet.index') }}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> 返回首页
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted mb-3">任务信息</h6>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>任务名称:</strong></div>
                                            <div class="col-8 text-primary" id="task-name">-</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>任务ID:</strong></div>
                                            <div class="col-8 text-muted small" id="task-id">-</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>状态:</strong></div>
                                            <div class="col-8" id="task-status">-</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>进度:</strong></div>
                                            <div class="col-8" id="task-progress">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted mb-3">时间信息</h6>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>开始时间:</strong></div>
                                            <div class="col-8 text-success" id="start-time">-</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>结束时间:</strong></div>
                                            <div class="col-8 text-info" id="end-time">-</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>执行时长:</strong></div>
                                            <div class="col-8 text-warning" id="execution-duration">-</div>
                                        </div>
                                        <div class="row mb-2" id="error-info" style="display: none;">
                                            <div class="col-4"><strong>错误信息:</strong></div>
                                            <div class="col-8 text-danger" id="error-message">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-primary text-white h-100">
                            <div class="card-body text-center">
                                <h5 class="card-title">执行统计</h5>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h3 id="success-count">0</h3>
                                        <small>成功</small>
                                    </div>
                                    <div class="col-6">
                                        <h3 id="failed-count">0</h3>
                                        <small>失败</small>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" id="success-progress" style="width: 0%"></div>
                                    </div>
                                    <small class="mt-1 d-block">成功率</small>
                                </div>
                                
                                <!-- 刷新控制区域 -->
                                <div class="mt-4 pt-3 border-top border-light">
                                    <div class="row g-2">
                                        <div class="col-8">
                                            <select class="form-select form-select-sm" id="refresh-frequency">
                                                <option value="5000">5秒</option>
                                                <option value="15000">15秒</option>
                                                <option value="30000">30秒</option>
                                                <option value="60000" selected>1分钟</option>
                                                <option value="120000">2分钟</option>
                                                <option value="300000">5分钟</option>
                                                <option value="600000">10分钟</option>
                                            </select>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-light btn-sm w-100" id="manual-refresh-btn" title="手动刷新">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <small class="text-light mt-1 d-block">自动刷新</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配置信息卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-gear"></i> 配置信息
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Google Sheet 配置</h6>
                        <div id="config-container">
                            <!-- 配置信息将通过JavaScript动态填充 -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">参数配置</h6>
                        <div id="parameters-container">
                            <!-- 参数信息将通过JavaScript动态填充 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-journal-text"></i> 任务日志
                </h4>
            </div>
            <div class="card-body">
                <div class="log-container" id="log-container">
                    <!-- 日志内容将通过JavaScript动态填充 -->
                </div>
            </div>
        </div>

        <!-- 执行结果卡片 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="bi bi-list-check"></i> 执行结果
                </h4>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshResults()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-funnel"></i> 筛选
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="filterResults('all')">全部结果</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterResults('success')">成功</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterResults('failed')">失败</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm" id="results-table" style="margin-bottom: 0;">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 60px;">序号</th>
                                <th style="width: 200px;">参数组合</th>
                                <th style="width: 300px;">执行结果</th>
                                <th style="width: 80px;">状态</th>
                                <th style="width: 140px;">执行时间</th>
                                <th style="width: 80px;">耗时</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- 结果列表将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <nav aria-label="结果分页">
                    <ul class="pagination justify-content-center" id="results-pagination">
                        <!-- 分页按钮将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* 优化结果表格样式 */
    #results-table {
        font-size: 0.875rem;
    }
    
    #results-table td {
        vertical-align: middle;
        padding: 0.5rem 0.75rem;
    }
    
    #results-table th {
        padding: 0.75rem 0.75rem;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .result-content {
        max-height: 120px;
        overflow-y: auto;
        font-size: 0.75rem;
        line-height: 1.3;
    }
    
    .result-content pre {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 8px;
        margin: 0;
        font-family: 'Courier New', monospace;
        font-size: 0.7rem;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .result-content::-webkit-scrollbar {
        width: 4px;
    }
    
    .result-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }
    
    .result-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 2px;
    }
    
    .result-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* 参数组合标签样式 */
    .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* 状态徽章样式 */
    .badge.bg-success, .badge.bg-danger {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
    }
    
    /* 表格行悬停效果 */
    #results-table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    /* 紧凑型分页 */
    .pagination {
        margin-bottom: 0;
        padding-top: 1rem;
    }
    
    .page-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* 旋转动画 */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
<script>
    // 全局变量
    let currentTaskId = null;
    let statusInterval = null;
    let refreshInterval = null;
    let allResults = [];
    let filteredResults = [];
    let currentResultsPage = 1;
    let resultsPerPage = 10;
    let currentResultsFilter = 'all';
    let currentRefreshFrequency = 60000; // 默认1分钟，将从配置加载
    let taskStartTime = null; // 存储任务开始时间

    // 页面加载完成后获取任务详情
    document.addEventListener('DOMContentLoaded', function() {
        console.log('页面加载完成');
        currentTaskId = getTaskIdFromUrl();
        console.log('获取到的任务ID:', currentTaskId);
        if (currentTaskId) {
            // 从配置加载默认刷新频率
            ajaxRequest('/api/config', 'GET', null, function(err, data) {
                if (!err && data && data.config && data.config.detail_refresh_interval) {
                    currentRefreshFrequency = data.config.detail_refresh_interval;
                    // 更新下拉框的默认选择
                    const frequencySelect = document.getElementById('refresh-frequency');
                    if (frequencySelect) {
                        frequencySelect.value = currentRefreshFrequency;
                    }
                }
                
                loadTaskDetail();
                initializeRefreshControls();
                // 启动自动刷新
                startAutoRefresh();
            });
        } else {
            showNotification('任务ID无效', 'error');
        }
    });

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });

    // 初始化刷新控制
    function initializeRefreshControls() {
        const frequencySelect = document.getElementById('refresh-frequency');
        const manualRefreshBtn = document.getElementById('manual-refresh-btn');
        
        // 刷新频率选择事件
        frequencySelect.addEventListener('change', function() {
            currentRefreshFrequency = parseInt(this.value);
            console.log('刷新频率更改为:', currentRefreshFrequency + 'ms');
            startAutoRefresh(); // 重新启动自动刷新
            showNotification(`自动刷新频率已设置为 ${getFrequencyText(currentRefreshFrequency)}`, 'info');
        });
        
        // 手动刷新按钮事件
        manualRefreshBtn.addEventListener('click', function() {
            manualRefresh();
        });
    }

    // 获取频率文本
    function getFrequencyText(milliseconds) {
        const seconds = milliseconds / 1000;
        if (seconds < 60) {
            return `${seconds}秒`;
        } else {
            const minutes = seconds / 60;
            return `${minutes}分钟`;
        }
    }

    // 手动刷新
    function manualRefresh() {
        const btn = document.getElementById('manual-refresh-btn');
        const icon = btn.querySelector('i');
        
        // 添加旋转动画
        icon.style.animation = 'spin 1s linear infinite';
        btn.disabled = true;
        
        console.log('执行手动刷新...');
        loadTaskDetail();
        
        // 1秒后恢复按钮
        setTimeout(() => {
            icon.style.animation = '';
            btn.disabled = false;
        }, 1000);
        
        showNotification('手动刷新完成', 'success');
    }

    // 获取URL中的任务ID
    function getTaskIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('task_id');
    }

    // 加载任务详情
    function loadTaskDetail() {
        console.log('开始加载任务详情，任务ID:', currentTaskId);
        ajaxRequest(`/api/tasks/${currentTaskId}`, 'GET', null, function(err, data) {
            console.log('API响应:', err, data);
            if (!err && data && data.task) {
                const task = data.task;
                console.log('任务数据:', task);
                
                // 填充基本信息
                document.getElementById('task-id').textContent = task.id;
                document.getElementById('task-name').textContent = task.name;
                document.getElementById('task-status').innerHTML = `<span class="badge ${getStatusClass(task.status)}">${getStatusText(task.status)}</span>`;
                
                // 更新进度显示
                const progressPercent = task.total_steps > 0 ? Math.round((task.current_step / task.total_steps) * 100) : 0;
                document.getElementById('task-progress').innerHTML = `
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${getProgressBarClass(task.status)}" role="progressbar" 
                             style="width: ${progressPercent}%">
                            ${task.current_step}/${task.total_steps} (${progressPercent}%)
                        </div>
                    </div>
                `;
                
                // 更新时间信息
                document.getElementById('start-time').textContent = formatTime(task.start_time);
                document.getElementById('end-time').textContent = formatTime(task.end_time);
                
                // 保存任务开始时间用于计算耗时
                if (task.start_time) {
                    taskStartTime = new Date(task.start_time);
                }
                
                // 计算执行时长
                let duration = 0;
                if (task.start_time) {
                    const startTime = new Date(task.start_time);
                    const endTime = task.end_time ? new Date(task.end_time) : new Date();
                    duration = Math.max(0, Math.round((endTime - startTime) / 1000)); // 确保不为负数
                }
                document.getElementById('execution-duration').textContent = formatDuration(duration);
                
                // 显示/隐藏错误信息
                const errorInfo = document.getElementById('error-info');
                if (task.error_message) {
                    document.getElementById('error-message').textContent = task.error_message;
                    errorInfo.style.display = 'block';
                } else {
                    errorInfo.style.display = 'none';
                }
                
                // 显示/隐藏取消按钮
                const cancelBtn = document.getElementById('cancel-task-btn');
                if (task.status === 'running') {
                    cancelBtn.style.display = 'inline-block';
                    cancelBtn.setAttribute('data-task-id', task.id);
                } else {
                    cancelBtn.style.display = 'none';
                }
                
                // 显示/隐藏重启按钮（包括pending状态）
                const restartBtn = document.getElementById('restart-dropdown-btn');
                if (task.status === 'pending' || task.status === 'completed' || task.status === 'error' || task.status === 'cancelled') {
                    restartBtn.style.display = 'inline-block';
                } else {
                    restartBtn.style.display = 'none';
                }
                
                // 填充配置信息
                loadTaskConfig(task.config);
                loadTaskParameters(task.config);
                
                // 加载任务日志
                loadTaskLogs();
                
                // 加载任务结果
                loadTaskResults();
                
                // 更新页面标题
                document.title = `任务详情 - ${task.name}`;
                
                // 如果任务还在运行，启动定时刷新
                if (task.status === 'running') {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            } else {
                showNotification('获取任务详情失败: ' + (data ? data.message : '未知错误'), 'error');
            }
        });
    }

    // 加载任务配置
    function loadTaskConfig(config) {
        const container = document.getElementById('config-container');
        container.innerHTML = '';
        
        if (config) {
            const configItems = [
                { label: '电子表格ID', value: config.spreadsheet_id || '-', icon: 'bi-link-45deg' },
                { label: '工作表名称', value: config.sheet_name || '-', icon: 'bi-file-spreadsheet' },
                { label: '认证方式', value: config.token_type || '-', icon: 'bi-shield-lock' },
                { label: '代理URL', value: config.proxy_url || '无', icon: 'bi-globe' },
                { label: '参数数量', value: config.parameters ? config.parameters.length : 0, icon: 'bi-list-ul' }
            ];
            
            configItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-2 d-flex align-items-center';
                itemDiv.innerHTML = `
                    <i class="${item.icon} text-muted me-2"></i>
                    <strong class="me-2">${item.label}:</strong>
                    <span class="text-muted">${item.value}</span>
                `;
                container.appendChild(itemDiv);
            });
        } else {
            container.innerHTML = '<div class="text-muted">无配置信息</div>';
        }
    }

    // 加载任务日志
    function loadTaskLogs() {
        console.log('开始加载任务日志...');
        ajaxRequest(`/api/tasks/${currentTaskId}/logs`, 'GET', null, function(err, data) {
            console.log('日志API响应:', err, data);
            if (!err && data && data.logs) {
                const logContainer = document.getElementById('log-container');
                console.log('找到日志容器:', logContainer);
                console.log('日志数量:', data.logs.length);
                
                if (data.logs.length > 0) {
                    // 保存当前滚动位置
                    const wasAtBottom = logContainer.scrollTop + logContainer.clientHeight >= logContainer.scrollHeight - 5;
                    
                    // 更新日志内容
                    logContainer.innerHTML = data.logs.map(log => {
                        const level = log.level || 'info';
                        const levelClass = level === 'error' ? 'text-danger' : 
                                         level === 'warning' ? 'text-warning' : 
                                         level === 'info' ? 'text-info' : 'text-light';
                        return `<div class="${levelClass}">[${formatTime(log.timestamp)}] ${log.message}</div>`;
                    }).join('');
                    
                    // 如果之前在底部，保持滚动到底部
                    if (wasAtBottom) {
                logContainer.scrollTop = logContainer.scrollHeight;
                    }
                    
                    console.log('日志已显示');
                } else {
                    logContainer.innerHTML = '<div class="text-muted">暂无日志</div>';
                    console.log('没有日志数据');
                }
            } else {
                console.error('加载日志失败:', err, data);
                const logContainer = document.getElementById('log-container');
                logContainer.innerHTML = '<div class="text-danger">加载日志失败</div>';
            }
        });
    }

    // 加载任务参数
    function loadTaskParameters(config) {
        const container = document.getElementById('parameters-container');
        container.innerHTML = '';
        
        if (config && config.parameters) {
            config.parameters.forEach((param, index) => {
                const paramDiv = document.createElement('div');
                paramDiv.className = 'mb-2';
                paramDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">参数${index + 1}</span>
                        <code class="text-dark">${JSON.stringify(param)}</code>
                    </div>
                `;
                container.appendChild(paramDiv);
            });
        } else {
            container.innerHTML = '<div class="text-muted">无参数配置</div>';
        }
    }

    // 加载任务结果
    function loadTaskResults() {
        ajaxRequest(`/api/tasks/${currentTaskId}/results`, 'GET', null, function(err, data) {
            if (!err && data && data.results) {
                allResults = data.results;
                applyResultsFilter();
                updateResultsStatistics();
                renderResults();
            }
        });
    }

    // 应用结果筛选
    function applyResultsFilter() {
        if (currentResultsFilter === 'all') {
            filteredResults = allResults;
        } else if (currentResultsFilter === 'success') {
            filteredResults = allResults.filter(result => result.success);
        } else if (currentResultsFilter === 'failed') {
            filteredResults = allResults.filter(result => !result.success);
        }
        currentResultsPage = 1; // 重置到第一页
    }

    // 筛选结果
    function filterResults(filter) {
        currentResultsFilter = filter;
        applyResultsFilter();
        renderResults();
    }

    // 渲染结果列表
    function renderResults() {
        const tbody = document.getElementById('results-table-body');
        tbody.innerHTML = '';
        
        // 计算分页
        const startIndex = (currentResultsPage - 1) * resultsPerPage;
        const endIndex = startIndex + resultsPerPage;
        const pageResults = filteredResults.slice(startIndex, endIndex);
        
        // 填充结果列表
        pageResults.forEach(result => {
            const row = document.createElement('tr');
            
            // 计算耗时：当前结果时间与上一个结果时间比较
            let executionTime = '-';
            if (result.timestamp) {
                const currentResultTime = new Date(result.timestamp);
                if (!isNaN(currentResultTime.getTime())) {
                    let previousTime = taskStartTime; // 默认使用任务开始时间
                    
                    // 如果有上一个结果，使用上一个结果的时间
                    if (index > 0) {
                        const prevResult = filteredResults[index - 1];
                        if (prevResult && prevResult.timestamp) {
                            previousTime = new Date(prevResult.timestamp);
                        }
                    }
                    
                    const durationMs = currentResultTime - previousTime;
                    const durationSeconds = Math.round(durationMs / 1000);
                    if (durationSeconds >= 0) {
                        executionTime = formatDuration(durationSeconds);
                    }
                }
            }
            
            row.innerHTML = `
                <td>${result.step_index + 1}</td>
                <td>
                    <div class="d-flex flex-wrap gap-1">
                        ${result.parameters.map((param, i) => 
                            `<span class="badge bg-secondary" style="font-size: 0.75rem;">${param}</span>`
                        ).join('')}
                    </div>
                </td>
                <td>
                    <div class="result-content">
                        ${result.result ? `<pre class="mb-0 small text-dark">${JSON.stringify(result.result, null, 2)}</pre>` : '<span class="text-muted">-</span>'}
                    </div>
                </td>
                <td>
                    <span class="badge ${result.success ? 'bg-success' : 'bg-danger'}">
                        <i class="bi ${result.success ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                        ${result.success ? '成功' : '失败'}
                    </span>
                </td>
                <td>${formatTime(result.timestamp)}</td>
                <td>${executionTime}</td>
            `;
            tbody.appendChild(row);
        });
        
        // 渲染分页
        renderResultsPagination();
    }

    // 渲染结果分页
    function renderResultsPagination() {
        const pagination = document.getElementById('results-pagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(filteredResults.length / resultsPerPage);
        
        if (totalPages <= 1) return;
        
        // 上一页
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentResultsPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changeResultsPage(${currentResultsPage - 1})">上一页</a>`;
        pagination.appendChild(prevLi);
        
        // 页码
        const startPage = Math.max(1, currentResultsPage - 2);
        const endPage = Math.min(totalPages, currentResultsPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentResultsPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changeResultsPage(${i})">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // 下一页
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentResultsPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changeResultsPage(${currentResultsPage + 1})">下一页</a>`;
        pagination.appendChild(nextLi);
    }

    // 切换结果页面
    function changeResultsPage(page) {
        const totalPages = Math.ceil(filteredResults.length / resultsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentResultsPage = page;
            renderResults();
        }
    }

    // 刷新结果
    function refreshResults() {
        loadTaskResults();
        showNotification('结果列表已刷新', 'info');
    }

    // 更新结果统计
    function updateResultsStatistics() {
        const successCount = allResults.filter(result => result.success).length;
        const failedCount = allResults.filter(result => !result.success).length;
        const totalCount = allResults.length;
        const successRate = totalCount > 0 ? Math.round((successCount / totalCount) * 100) : 0;
        
        document.getElementById('success-count').textContent = successCount;
        document.getElementById('failed-count').textContent = failedCount;
        document.getElementById('success-progress').style.width = successRate + '%';
    }

    // 取消任务
    function cancelTask() {
        if (confirm('确定要取消这个任务吗？')) {
            ajaxRequest(`/api/tasks/${currentTaskId}/cancel`, 'POST', null, function(err, data) {
                if (!err && data && data.status === 'success') {
                    showNotification('任务已取消', 'success');
                    loadTaskDetail(); // 刷新任务详情
                } else {
                    showNotification('取消任务失败: ' + (data ? data.message : '未知错误'), 'error');
                }
            });
        }
    }

    // 自动刷新相关变量（已在全局变量中声明）
    
    // 启动自动刷新
    function startAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        
        console.log(`启动自动刷新，每${getFrequencyText(currentRefreshFrequency)}刷新一次`);
        refreshInterval = setInterval(function() {
            console.log('自动刷新任务详情和日志...');
            loadTaskDetail(); // 这会重新加载所有信息，包括日志
        }, currentRefreshFrequency);
    }
    
    // 停止自动刷新
    function stopAutoRefresh() {
        if (refreshInterval) {
            console.log('停止自动刷新');
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }
    
    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });

    // 绑定取消任务按钮事件
    document.addEventListener('click', function(e) {
        if (e.target.id === 'cancel-task-btn') {
            cancelTask();
        }
    });

    // 辅助函数
    function formatDuration(seconds) {
        if (seconds < 60) {
            return `${seconds}秒`;
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}分${remainingSeconds}秒`;
        } else {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}小时${minutes}分钟`;
        }
    }

    function getProgressBarClass(status) {
        switch(status) {
            case 'completed': return 'bg-success';
            case 'error': return 'bg-danger';
            case 'running': return 'bg-primary';
            default: return 'bg-secondary';
        }
    }

    // 检查任务状态
    function checkTaskStatus() {
        const btn = document.getElementById('check-status-btn');
        const icon = btn.querySelector('i');
        
        // 添加旋转动画
        icon.style.animation = 'spin 1s linear infinite';
        btn.disabled = true;
        
        ajaxRequest(`/api/tasks/${currentTaskId}/status-check`, 'GET', null, function(err, data) {
            icon.style.animation = '';
            btn.disabled = false;
            
            if (!err && data && data.status === 'success') {
                const statusCheck = data.status_check;
                let message = `状态检查结果:\n`;
                message += `数据库状态: ${statusCheck.db_status}\n`;
                message += `内存运行状态: ${statusCheck.memory_running ? '运行中' : '未运行'}\n`;
                message += `当前步骤: ${statusCheck.current_step}/${statusCheck.total_steps}\n`;
                
                if (statusCheck.latest_log_time) {
                    message += `最新日志时间: ${formatTime(statusCheck.latest_log_time)}\n`;
                }
                
                if (statusCheck.can_restart) {
                    message += `\n⚠️ 检测到问题: ${statusCheck.restart_reason}\n`;
                    message += `建议重启任务`;
                    
                    if (confirm(message + '\n\n是否立即重启任务？')) {
                        restartTask(true);
                    }
                } else {
                    message += `\n✅ 任务状态正常`;
                    showNotification(message, 'info');
                }
            } else {
                showNotification('检查任务状态失败: ' + (data ? data.message : '未知错误'), 'error');
            }
        });
    }

    // 重启任务
    function restartTask(resumeFromCheckpoint) {
        const action = resumeFromCheckpoint ? '从断点重启' : '从头重启';
        
        if (!confirm(`确定要${action}任务吗？`)) {
            return;
        }
        
        const requestData = {
            resume_from_checkpoint: resumeFromCheckpoint
        };
        
        ajaxRequest(`/api/tasks/${currentTaskId}/restart`, 'POST', requestData, function(err, data) {
            if (data && data.status === 'success') {
                showNotification(`任务${action}成功`, 'success');
                // 刷新任务详情
                loadTaskDetail();
            } else {
                // 处理错误情况 - data可能包含错误信息，即使err存在
                const errorMessage = (data && data.message) ? data.message : (err ? err.message : '未知错误');
                showNotification(`${action}失败: ${errorMessage}`, 'error');
            }
        });
    }

    // 跳转到创建重启任务页面
    function goToCreateRestartTask() {
        window.location.href = `/google-sheet/create-restart/${currentTaskId}`;
    }

    // 创建新的重启任务
    function createRestartTask() {
        if (!confirm('确定要创建新的重启任务吗？这将基于当前任务的配置创建一个新任务。')) {
            return;
        }
        
        ajaxRequest(`/api/tasks/${currentTaskId}/create-restart`, 'POST', {}, function(err, data) {
            if (data && data.status === 'success') {
                showNotification(`新重启任务创建成功`, 'success');
                
                // 询问是否跳转到新任务
                if (confirm('是否跳转到新任务的详情页面？')) {
                    window.location.href = `/google-sheet/detail?task_id=${data.new_task_id}`;
                }
            } else {
                // 处理错误情况 - data可能包含错误信息，即使err存在
                const errorMessage = (data && data.message) ? data.message : (err ? err.message : '未知错误');
                showNotification(`创建重启任务失败: ${errorMessage}`, 'error');
            }
        });
    }
</script>
{% endblock %}
