{% extends "admin/base.html" %}

{% block title %}系统日志 - 任务管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">系统日志</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                <i class="bi bi-trash"></i> 清空日志
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadLogs()">
                <i class="bi bi-download"></i> 下载日志
            </button>
        </div>
    </div>
</div>

<!-- 日志筛选 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="level-filter" class="form-label">日志级别</label>
                <select class="form-select" id="level-filter" onchange="filterLogs()">
                    <option value="">全部级别</option>
                    <option value="info">信息</option>
                    <option value="warning">警告</option>
                    <option value="error">错误</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="search-input" class="form-label">搜索</label>
                <input type="text" class="form-control" id="search-input" placeholder="搜索日志内容..." onkeyup="filterLogs()">
            </div>
            <div class="col-md-3">
                <label for="date-filter" class="form-label">日期筛选</label>
                <input type="date" class="form-control" id="date-filter" onchange="filterLogs()">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> 清除筛选
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 日志显示 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-journal-text"></i> 系统日志
            <span class="badge bg-secondary ms-2" id="log-count">0</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="log-container" id="log-container">
            <!-- 日志内容将通过JavaScript动态填充 -->
        </div>
    </div>
</div>

<!-- 日志详情模态框 -->
<div class="modal fade" id="logDetailModal" tabindex="-1" aria-labelledby="logDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailModalLabel">日志详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr><th>时间:</th><td id="detail-log-time"></td></tr>
                            <tr><th>级别:</th><td id="detail-log-level"></td></tr>
                            <tr><th>来源:</th><td id="detail-log-source"></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>日志内容</h6>
                        <pre id="detail-log-message" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allLogs = [];
    let filteredLogs = [];
    let autoRefresh = true;
    let refreshInterval;

    // 页面加载完成后获取日志
    document.addEventListener('DOMContentLoaded', function() {
        loadLogs();
        // 每5秒自动刷新一次
        refreshInterval = setInterval(function() {
            if (autoRefresh) {
                loadLogs();
            }
        }, 5000);
    });

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });

    function loadLogs() {
        // 这里应该调用实际的日志API
        // 由于原项目没有日志API，我们模拟一些日志数据
        const mockLogs = [
            {
                timestamp: new Date().toISOString(),
                level: 'info',
                message: '系统启动成功',
                source: 'system'
            },
            {
                timestamp: new Date(Date.now() - 60000).toISOString(),
                level: 'info',
                message: '任务管理器初始化完成',
                source: 'task_manager'
            },
            {
                timestamp: new Date(Date.now() - 120000).toISOString(),
                level: 'warning',
                message: '检测到长时间运行的任务',
                source: 'task_monitor'
            },
            {
                timestamp: new Date(Date.now() - 180000).toISOString(),
                level: 'error',
                message: 'Google Sheet连接失败',
                source: 'google_sheet_service'
            }
        ];
        
        allLogs = mockLogs;
        filterLogs();
    }

    function filterLogs() {
        const levelFilter = document.getElementById('level-filter').value;
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const dateFilter = document.getElementById('date-filter').value;

        filteredLogs = allLogs.filter(log => {
            const levelMatch = !levelFilter || log.level === levelFilter;
            const searchMatch = !searchInput || log.message.toLowerCase().includes(searchInput);
            const dateMatch = !dateFilter || log.timestamp.startsWith(dateFilter);
            
            return levelMatch && searchMatch && dateMatch;
        });

        renderLogs();
    }

    function clearFilters() {
        document.getElementById('level-filter').value = '';
        document.getElementById('search-input').value = '';
        document.getElementById('date-filter').value = '';
        filterLogs();
    }

    function renderLogs() {
        const container = document.getElementById('log-container');
        const countBadge = document.getElementById('log-count');
        
        countBadge.textContent = filteredLogs.length;
        
        if (filteredLogs.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">暂无日志</div>';
            return;
        }

        const logHtml = filteredLogs.map(log => {
            const levelClass = getLevelClass(log.level);
            const levelText = getLevelText(log.level);
            const time = formatTime(log.timestamp);
            
            return `
                <div class="log-entry mb-2 p-2 border-bottom" onclick="showLogDetail('${log.timestamp}')" style="cursor: pointer;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <span class="badge ${levelClass} me-2">${levelText}</span>
                            <span class="text-muted small">${time}</span>
                            <span class="text-muted small ms-2">[${log.source}]</span>
                        </div>
                    </div>
                    <div class="mt-1">${log.message}</div>
                </div>
            `;
        }).join('');

        container.innerHTML = logHtml;
        
        // 滚动到底部
        container.scrollTop = container.scrollHeight;
    }

    function getLevelClass(level) {
        switch (level) {
            case 'info': return 'bg-info';
            case 'warning': return 'bg-warning';
            case 'error': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function getLevelText(level) {
        switch (level) {
            case 'info': return '信息';
            case 'warning': return '警告';
            case 'error': return '错误';
            default: return level;
        }
    }

    function showLogDetail(timestamp) {
        const log = allLogs.find(l => l.timestamp === timestamp);
        if (!log) return;

        document.getElementById('detail-log-time').textContent = formatTime(log.timestamp);
        document.getElementById('detail-log-level').innerHTML = `<span class="badge ${getLevelClass(log.level)}">${getLevelText(log.level)}</span>`;
        document.getElementById('detail-log-source').textContent = log.source;
        document.getElementById('detail-log-message').textContent = log.message;

        const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
        modal.show();
    }

    function refreshLogs() {
        loadLogs();
        showNotification('日志已刷新', 'success');
    }

    function clearLogs() {
        if (confirm('确定要清空所有日志吗？此操作不可恢复。')) {
            // 这里应该调用清空日志的API
            allLogs = [];
            filterLogs();
            showNotification('日志已清空', 'success');
        }
    }

    function downloadLogs() {
        if (filteredLogs.length === 0) {
            showNotification('没有日志可下载', 'warning');
            return;
        }

        const logText = filteredLogs.map(log => 
            `[${formatTime(log.timestamp)}] [${log.level.toUpperCase()}] [${log.source}] ${log.message}`
        ).join('\n');

        const blob = new Blob([logText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `system_logs_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showNotification('日志下载完成', 'success');
    }

    // 切换自动刷新
    function toggleAutoRefresh() {
        autoRefresh = !autoRefresh;
        const btn = document.getElementById('auto-refresh-btn');
        if (autoRefresh) {
            btn.innerHTML = '<i class="bi bi-pause-circle"></i> 暂停自动刷新';
            btn.className = 'btn btn-sm btn-outline-warning';
        } else {
            btn.innerHTML = '<i class="bi bi-play-circle"></i> 开始自动刷新';
            btn.className = 'btn btn-sm btn-outline-success';
        }
    }
</script>
{% endblock %}
