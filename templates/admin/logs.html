{% extends "admin/base.html" %}

{% block title %}系统日志 - 任务管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">系统日志</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                <i class="bi bi-trash"></i> 清空日志
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadLogs()">
                <i class="bi bi-download"></i> 下载日志
            </button>
        </div>
    </div>
</div>

<!-- 日志筛选 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="level-filter" class="form-label">日志级别</label>
                <select class="form-select" id="level-filter" onchange="filterLogs()">
                    <option value="">全部级别</option>
                    <option value="info">信息</option>
                    <option value="warning">警告</option>
                    <option value="error">错误</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="search-input" class="form-label">搜索</label>
                <input type="text" class="form-control" id="search-input" placeholder="搜索日志内容..." onkeyup="filterLogs()">
            </div>
            <div class="col-md-3">
                <label for="date-filter" class="form-label">日期筛选</label>
                <input type="date" class="form-control" id="date-filter" onchange="filterLogs()">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> 清除筛选
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 日志显示 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-journal-text"></i> 系统日志
            <span class="badge bg-secondary ms-2" id="log-count">0</span>
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="log-container" id="log-container" style="
            background: #1e1e1e; 
            color: #d4d4d4; 
            height: 600px; 
            overflow-y: auto; 
            padding: 10px; 
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        ">
            <!-- 日志内容将通过JavaScript动态填充 -->
        </div>
    </div>
</div>

<!-- 简化的日志显示，不需要模态框 -->
{% endblock %}

{% block scripts %}
<script>
    let allLogs = [];
    let filteredLogs = [];
    let autoRefresh = true;
    let refreshInterval;

    // 页面加载完成后获取日志
    document.addEventListener('DOMContentLoaded', function() {
        // 延迟加载，确保DOM完全准备好
        setTimeout(function() {
            loadLogs();
        }, 100);
        
        // 每5秒自动刷新一次
        refreshInterval = setInterval(function() {
            if (autoRefresh) {
                loadLogs();
            }
        }, 5000);
    });

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        stopRealtimeUpdate();
    });

    function loadLogs() {
        // 显示加载状态
        showLoadingState();
        
        // 构建查询参数
        const params = new URLSearchParams();
        const levelFilterEl = document.getElementById('level-filter');
        const searchInputEl = document.getElementById('search-input');
        const dateFilterEl = document.getElementById('date-filter');
        
        const levelFilter = levelFilterEl ? levelFilterEl.value : '';
        const searchInput = searchInputEl ? searchInputEl.value : '';
        const dateFilter = dateFilterEl ? dateFilterEl.value : '';
        
        if (levelFilter) params.append('level', levelFilter);
        if (searchInput) params.append('search', searchInput);
        if (dateFilter) params.append('date', dateFilter);
        params.append('limit', '200'); // 获取更多日志
        
        // 调用真实的日志API
        console.log('开始加载日志，API URL:', `/api/logs?${params.toString()}`);
        
        ajaxRequest(`/api/logs?${params.toString()}`, 'GET', null, function(err, data) {
            hideLoadingState();
            
            console.log('日志API响应:', err, data);
            
            if (!err && data && data.status === 'success') {
                allLogs = data.logs || [];
                filteredLogs = allLogs; // 服务端已经过滤，直接使用
                console.log('加载到的日志数量:', allLogs.length);
                renderLogs();
                
                // 更新最后更新时间
                const lastUpdateEl = document.getElementById('last-update');
                if (lastUpdateEl) {
                    lastUpdateEl.textContent = formatTime(new Date().toISOString());
                }
            } else {
                console.error('日志加载失败:', err, data);
                showNotification('加载日志失败: ' + (data ? data.message : '未知错误'), 'error');
                
                // 如果API失败，显示空状态
                allLogs = [];
                filteredLogs = [];
                renderLogs();
            }
        });
    }

    function filterLogs() {
        // 重新加载数据，服务端处理过滤
        loadLogs();
    }

    function clearFilters() {
        document.getElementById('level-filter').value = '';
        document.getElementById('search-input').value = '';
        document.getElementById('date-filter').value = '';
        filterLogs();
    }

    function renderLogs() {
        const container = document.getElementById('log-container');
        const countBadge = document.getElementById('log-count');
        
        if (!container) {
            console.error('日志容器未找到');
            return;
        }
        
        if (countBadge) {
            countBadge.textContent = filteredLogs.length;
        }
        
        if (filteredLogs.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">暂无日志</div>';
            return;
        }

        const logHtml = filteredLogs.map(log => {
            const time = formatTime(log.timestamp);
            const levelColor = getLevelColor(log.level);
            
            return `
                <div class="log-line" style="margin-bottom: 2px;">
                    <span style="color: #7c7c7c;">${time}</span> 
                    <span style="color: ${levelColor}; font-weight: bold;">[${log.level.toUpperCase()}]</span> 
                    <span style="color: #8c8c8c;">[${log.source}]</span> 
                    <span style="color: #d4d4d4;">${log.message}</span>
                </div>
            `;
        }).join('');

        // 保存当前滚动位置
        const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 5;
        
        container.innerHTML = logHtml;
        
        // 如果之前在底部，保持滚动到底部
        if (wasAtBottom) {
            container.scrollTop = container.scrollHeight;
        }
    }

    function getLevelColor(level) {
        switch (level) {
            case 'info': return '#0d6efd';     // 蓝色
            case 'warning': return '#fd7e14';  // 橙色
            case 'error': return '#dc3545';    // 红色
            default: return '#6c757d';         // 灰色
        }
    }

    function refreshLogs() {
        loadLogs();
        showNotification('日志已刷新', 'success');
    }

    function clearLogs() {
        if (confirm('确定要清空所有日志吗？此操作不可恢复。')) {
            showNotification('清空日志功能暂未实现', 'warning');
            // TODO: 实现清空日志的API调用
            // 目前只是展示功能，不实际清空文件日志
        }
    }

    function downloadLogs() {
        if (filteredLogs.length === 0) {
            showNotification('没有日志可下载', 'warning');
            return;
        }

        const logText = filteredLogs.map(log => 
            `[${formatTime(log.timestamp)}] [${log.level.toUpperCase()}] [${log.source}] ${log.message}`
        ).join('\n');

        const blob = new Blob([logText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `system_logs_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showNotification('日志下载完成', 'success');
    }

    // 切换自动刷新
    function toggleAutoRefresh() {
        autoRefresh = !autoRefresh;
        const btn = document.getElementById('auto-refresh-btn');
        if (autoRefresh) {
            btn.innerHTML = '<i class="bi bi-pause-circle"></i> 暂停自动刷新';
            btn.className = 'btn btn-sm btn-outline-warning';
            startRealtimeUpdate();
        } else {
            btn.innerHTML = '<i class="bi bi-play-circle"></i> 开始自动刷新';
            btn.className = 'btn btn-sm btn-outline-success';
            stopRealtimeUpdate();
        }
    }

    // 实时更新相关变量
    let realtimeInterval = null;
    let lastLogTimestamp = null;

    // 开始实时更新
    function startRealtimeUpdate() {
        if (realtimeInterval) {
            clearInterval(realtimeInterval);
        }
        
        // 记录当前最新日志的时间戳
        if (filteredLogs.length > 0) {
            lastLogTimestamp = filteredLogs[0].timestamp;
        }
        
        realtimeInterval = setInterval(function() {
            fetchLatestLogs();
        }, 3000); // 每3秒检查一次新日志
    }

    // 停止实时更新
    function stopRealtimeUpdate() {
        if (realtimeInterval) {
            clearInterval(realtimeInterval);
            realtimeInterval = null;
        }
    }

    // 获取最新日志
    function fetchLatestLogs() {
        const params = new URLSearchParams();
        if (lastLogTimestamp) {
            params.append('since', lastLogTimestamp);
        }
        params.append('limit', '20');
        
        ajaxRequest(`/api/logs/latest?${params.toString()}`, 'GET', null, function(err, data) {
            if (!err && data && data.status === 'success' && data.logs.length > 0) {
                // 添加新日志到现有列表的顶部
                const newLogs = data.logs;
                
                // 更新最新时间戳
                if (newLogs.length > 0) {
                    lastLogTimestamp = newLogs[newLogs.length - 1].timestamp;
                }
                
                // 将新日志添加到列表开头（因为我们是倒序显示）
                filteredLogs = newLogs.reverse().concat(filteredLogs);
                
                // 限制总数以避免内存占用过多
                if (filteredLogs.length > 500) {
                    filteredLogs = filteredLogs.slice(0, 500);
                }
                
                // 重新渲染
                renderLogs();
                
                // 显示新日志通知
                if (newLogs.length > 0) {
                    showNotification(`收到 ${newLogs.length} 条新日志`, 'info');
                }
            }
        });
    }

    // 显示加载状态
    function showLoadingState() {
        const container = document.getElementById('log-container');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div class="mt-2 text-muted">正在加载日志...</div>
                </div>
            `;
        } else {
            console.error('日志容器未找到: log-container');
        }
    }

    // 隐藏加载状态
    function hideLoadingState() {
        // 加载状态会被renderLogs覆盖，这里不需要特殊处理
    }

    // 格式化时间
    function formatTime(dateString) {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (e) {
            return dateString;
        }
    }
</script>
{% endblock %}
