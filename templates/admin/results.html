{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">任务结果管理</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="input-group me-2">
                <input type="text" class="form-control" id="taskIdFilter" placeholder="输入任务ID筛选">
                <button class="btn btn-outline-secondary" type="button" id="filterButton">
                    <i class="fas fa-search"></i> 筛选
                </button>
            </div>
        </div>
    </div>

    <!-- 结果列表 -->
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>任务ID</th>
                    <th>步骤索引</th>
                    <th>状态</th>
                    <th>时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="resultList">
                <!-- 结果列表将通过JavaScript动态加载 -->
            </tbody>
        </table>
    </div>

    <!-- 分页控件 -->
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- 分页将通过JavaScript动态加载 -->
        </ul>
    </nav>
</div>

<!-- 查看结果详情模态框 -->
<div class="modal fade" id="viewResultModal" tabindex="-1" aria-labelledby="viewResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewResultModalLabel">结果详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>参数信息</h6>
                    <pre id="resultParameters" class="bg-light p-3 rounded"></pre>
                </div>
                <div class="mb-3">
                    <h6>执行结果</h6>
                    <pre id="resultData" class="bg-light p-3 rounded"></pre>
                </div>
                <div class="mb-3" id="errorMessageContainer" style="display: none;">
                    <h6>错误信息</h6>
                    <pre id="errorMessage" class="bg-light p-3 rounded text-danger"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
const pageSize = 20;
let currentTaskId = '';

// 显示错误提示
function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.table-responsive'));
    
    // 3秒后自动消失
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// 显示加载状态
function showLoading(show = true) {
    const resultList = document.getElementById('resultList');
    if (show) {
        resultList.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div class="mt-2">加载中...</div>
                </td>
            </tr>
        `;
    }
}

// 加载结果列表
function loadResults(page = 1) {
    showLoading(true);
    const url = new URL('/api/results', window.location.origin);
    url.searchParams.append('page', page);
    url.searchParams.append('per_page', pageSize);
    if (currentTaskId) {
        url.searchParams.append('task_id', currentTaskId);
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            const resultList = document.getElementById('resultList');
            resultList.innerHTML = '';
            
            data.results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.id}</td>
                    <td>${result.task_id}</td>
                    <td>${result.step_index}</td>
                    <td>
                        <span class="badge ${result.success ? 'bg-success' : 'bg-danger'}">
                            ${result.success ? '成功' : '失败'}
                        </span>
                    </td>
                    <td>${new Date(result.timestamp).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewResult(${result.id})">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteResult(${result.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                resultList.appendChild(row);
            });

            // 更新分页
            updatePagination(data.total, page);
        })
        .catch(error => console.error('Error:', error));
}

// 更新分页控件
function updatePagination(total, currentPage) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    // 上一页
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadResults(${currentPage - 1})" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
        </a>
    `;
    pagination.appendChild(prevLi);

    // 页码
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `
            <a class="page-link" href="#" onclick="loadResults(${i})">${i}</a>
        `;
        pagination.appendChild(li);
    }

    // 下一页
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadResults(${currentPage + 1})" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
        </a>
    `;
    pagination.appendChild(nextLi);
}

// 查看结果详情
function viewResult(id) {
    fetch(`/api/results/${id}`)
        .then(response => response.json())
        .then(result => {
            document.getElementById('resultParameters').textContent = JSON.stringify(result.parameters, null, 2);
            document.getElementById('resultData').textContent = JSON.stringify(result.result, null, 2);
            
            const errorContainer = document.getElementById('errorMessageContainer');
            const errorMessage = document.getElementById('errorMessage');
            if (result.error_message) {
                errorMessage.textContent = result.error_message;
                errorContainer.style.display = 'block';
            } else {
                errorContainer.style.display = 'none';
            }
            
            $('#viewResultModal').modal('show');
        })
        .catch(error => console.error('Error:', error));
}

// 删除结果
function deleteResult(id) {
    if (confirm('确定要删除这条结果记录吗？')) {
        fetch(`/api/results/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            loadResults(currentPage);
        })
        .catch(error => console.error('Error:', error));
    }
}

// 执行筛选
function doFilter() {
    currentTaskId = document.getElementById('taskIdFilter').value.trim();
    currentPage = 1;
    loadResults(1);
}

// 筛选按钮点击事件
document.getElementById('filterButton').addEventListener('click', doFilter);

// 任务ID输入框回车事件
document.getElementById('taskIdFilter').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        doFilter();
    }
});

// 页面加载时获取结果列表
document.addEventListener('DOMContentLoaded', () => {
    // 从URL参数中获取task_id
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('task_id');
    if (taskId) {
        document.getElementById('taskIdFilter').value = taskId;
        currentTaskId = taskId;
    }
    loadResults(1);
});
</script>
{% endblock %}
