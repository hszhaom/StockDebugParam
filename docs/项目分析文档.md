# 谷歌参数批量校验项目分析文档

## 1. 项目概述
该项目是一个基于Flask的Web应用，主要用于批量校验和处理Google Sheets中的参数数据。项目提供了任务管理、配置管理、日志记录等功能。

## 2. 系统架构

### 2.1 技术栈
- 后端：Python Flask
- 数据库：SQLite (通过SQLAlchemy ORM)
- 前端：HTML/CSS/JavaScript
- 容器化：Docker支持

### 2.2 核心模块
1. 任务管理模块 (Task Manager)
2. Google Sheet服务模块
3. 配置管理模块
4. 日志管理模块（**2025-10-13 重大升级**）
   - 新增任务专用日志记录器 (TaskLogger)
   - 支持任务ID标识和分类日志
   - 提供日志跟踪和搜索API

## 3. 数据模型

### 3.1 Task (任务)
- 主要属性：ID、名称、描述、状态、类型、配置信息
- 状态流转：pending -> running -> completed/error
- 支持进度追踪和错误记录

### 3.2 TaskLog (任务日志)
- 记录任务执行过程中的日志信息
- 支持不同级别的日志（info、warning、error）

### 3.3 TaskResult (任务结果)
- 记录每个任务步骤的执行结果
- 包含参数信息和执行结果
- 支持成功/失败状态记录

### 3.4 SystemConfig (系统配置)
- 存储系统级配置信息
- 支持配置项的增删改查

## 4. 功能模块

### 4.1 Google Sheet模块
- 支持创建Google Sheet校验任务
- 提供任务执行状态查看
- 支持任务重启功能

### 4.2 管理模块
- 仪表盘：显示任务统计信息
- 任务管理：查看和管理所有任务
- 配置管理：系统配置项管理
- 日志管理：系统日志查看

## 5. 部署相关
- 支持Docker容器化部署
- 提供docker-compose配置
- 支持Windows和Linux环境

## 6. 项目特点
1. 模块化设计，代码结构清晰
2. 完善的日志记录系统（**2025-10-13 重大升级**）
   - 任务专用日志记录器，支持任务ID前缀标识
   - 多级别日志分类（步骤、进度、API调用等）
   - 强大的日志搜索和过滤功能
3. 灵活的配置管理
4. 支持任务进度追踪
5. 提供友好的Web界面
6. 增强的异常处理和错误记录（**2025-10-13 新增**）

## 7. 最新功能更新

### 7.1 任务模板功能
1. 数据模型
   - 添加了 TaskTemplate 模型
   - 支持模板名称、描述、配置信息的存储
   - 添加了模板名称的索引以提高查询性能

2. 模板管理界面
   - 采用卡片式布局，展示模板列表
   - 显示模板的关键信息（工作表名称、参数组数等）
   - 支持模板的创建、编辑、复制、删除操作
   - 提供直观的操作菜单和按钮
   - 添加了空状态提示和加载状态

3. 模板使用功能
   - 支持从模板创建新任务
   - 自动填充模板配置信息
   - 提供清晰的用户界面反馈
   - 支持模板配置的修改和调整

4. 用户体验优化
   - 添加了更多的视觉反馈
   - 改进了错误处理和提示
   - 添加了操作确认机制
   - 优化了页面布局和交互

### 7.2 任务结果管理功能
1. 结果管理界面
   - 支持按任务ID筛选结果
   - 实现分页功能（每页20条）
   - 提供详细的结果信息展示
   - 支持结果的查看和删除操作

2. 数据展示优化
   - 清晰展示参数和结果信息
   - 支持JSON数据的格式化显示
   - 提供错误信息的突出显示
   - 添加了时间戳和状态标识

### 7.3 日志系统重大升级 (2025-10-13)

#### 7.3.1 TaskLogger 任务专用日志记录器
**核心特性：**
- 自动为所有任务相关日志添加 `[Task-{任务ID前8位}]` 前缀
- 提供多种专用日志方法满足不同场景需求
- 完全向后兼容，不影响现有日志功能

**专用日志方法：**
```python
task_logger = get_task_logger(task_id)
task_logger.step_info(1, 100, "开始执行参数组合")  # [Step 1/100] 开始执行参数组合
task_logger.progress_info(25.5, "处理中")        # [Progress 25.5%] 处理中
task_logger.api_info("发送数据", "stock_no: 000001") # [API] 发送数据 - stock_no: 000001
task_logger.api_error("获取数据", "连接超时")      # [API_ERROR] 获取数据 - 连接超时
```

#### 7.3.2 日志跟踪与搜索功能
**新增API端点：**
1. `GET /api/tasks/{task_id}/system-logs`
   - 获取特定任务的所有系统日志
   - 支持日志级别过滤（info/warning/error）
   - 返回按时间排序的日志列表

2. `GET /api/logs?task_id={task_id}`
   - 在全局日志中按任务ID过滤
   - 支持多种搜索模式
   - 支持组合过滤条件

**搜索模式：**
- 任务前缀匹配：`[Task-a1b2c3d4]`
- 中文标识匹配：`任务 {完整任务ID}`  
- 完整ID匹配：`{完整任务ID}`

#### 7.3.3 任务流程节点优化
**TaskManager 改进：**
- 任务创建：记录配置信息摘要和创建参数
- 任务启动：详细记录队列状态、线程创建过程
- 任务执行：增强异常处理，记录状态变更原因
- 资源清理：记录清理步骤，便于问题排查

**GoogleSheetService 改进：**
- 配置解析：添加JSON解析异常处理和错误上下文
- Google Sheet连接：记录连接参数和连接状态
- 参数组合执行：逐步记录每个组合的处理过程
- API调用：统一记录调用参数、结果和错误信息

#### 7.3.4 异常处理增强
**改进策略：**
- 所有关键操作包装在try-catch块中
- 异常信息包含完整的上下文信息
- 区分系统日志和任务数据库日志的记录
- 任务取消场景的特殊处理优化

#### 7.3.5 实际应用场景
**问题排查：**
1. **任务卡死问题**：`GET /api/tasks/{task_id}/system-logs` 快速定位最后执行步骤
2. **API调用问题**：搜索 `[API]` 或 `[API_ERROR]` 标签查看调用记录
3. **Google Sheet连接问题**：搜索连接相关日志定位网络问题
4. **参数处理问题**：通过步骤日志逐步跟踪参数组合处理

**性能监控：**
- 通过时间戳分析任务执行耗时
- 通过进度日志监控任务执行速度
- 通过API日志分析外部服务响应时间

**示例日志输出：**
```
2025-10-13 15:30:45,123 - app.services.task_manager - INFO - [Task-a1b2c3d4] 创建任务成功 - 名称: 股票参数校验, 类型: google_sheet, 配置项数量: 8
2025-10-13 15:30:45,234 - app.services.task_manager - INFO - [Task-a1b2c3d4] 开始启动任务 - 名称: 股票参数校验, 类型: google_sheet  
2025-10-13 15:30:45,345 - app.services.task_manager - INFO - [Task-a1b2c3d4] 创建任务事件队列成功
2025-10-13 15:30:45,456 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 开始执行Google Sheet任务
2025-10-13 15:30:46,123 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [Step 1/100] 开始执行参数组合
2025-10-13 15:30:47,234 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [API] 发送股票模板参数数据 - stock_no: 000001
```

### 7.4 待优化点
1. 可以添加更多的数据分析和可视化功能
2. 可以优化任务执行效率
3. 可以添加批量操作功能
4. 可以添加更多的模板分类和标签功能
5. 可以添加模板分享和导入导出功能