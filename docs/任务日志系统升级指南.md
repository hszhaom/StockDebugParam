# Google Task 任务日志系统升级指南

> 更新日期：2025-10-13
> 版本：v2.0
> 作者：AI Assistant

## 📋 概述

本次升级对Google Task任务执行过程中的日志系统进行了全面优化，主要目标是提升任务执行过程的可观测性和问题排查能力。通过引入任务专用日志记录器和增强的日志搜索功能，大幅提升了开发和运维效率。

## 🎯 升级目标

### 主要问题
1. **任务日志难以跟踪**：多个任务同时执行时，日志混杂在一起难以区分
2. **缺少执行细节**：无法清晰了解任务的具体执行步骤和进度
3. **异常排查困难**：错误信息不够详细，缺少上下文
4. **日志搜索不便**：无法按任务ID快速过滤相关日志

### 解决方案
1. **任务ID标识**：所有任务相关日志自动添加任务ID前缀
2. **分类日志记录**：提供步骤、进度、API调用等专用日志方法
3. **增强异常处理**：添加详细的错误上下文和堆栈信息
4. **专用搜索API**：提供按任务ID过滤日志的API端点

## 🔧 技术实现

### 1. TaskLogger 类设计

#### 核心类结构
```python
class TaskLogger:
    """任务专用日志记录器，自动添加任务ID前缀"""
    
    def __init__(self, task_id: str, logger_name: str = None):
        self.task_id = task_id
        self.logger = get_logger(logger_name or __name__)
        self.prefix = f"[Task-{task_id[:8]}]"  # 使用任务ID前8位作为前缀
    
    def _format_message(self, message: str) -> str:
        """格式化消息，添加任务ID前缀"""
        return f"{self.prefix} {message}"
```

#### 专用日志方法
```python
# 基础日志方法
task_logger.info("开始执行任务")
task_logger.warning("检测到潜在问题")  
task_logger.error("执行出现错误")
task_logger.exception("捕获异常")

# 专用日志方法
task_logger.step_info(1, 100, "开始执行参数组合")
task_logger.progress_info(25.5, "处理中")
task_logger.api_info("发送数据", "stock_no: 000001")
task_logger.api_error("获取数据", "连接超时")
```

### 2. 集成到现有系统

#### TaskManager 集成
```python
def _execute_google_sheet_task(self, task_id: str, app):
    # 创建任务专用日志记录器
    task_logger = get_task_logger(task_id, f"{__name__}.{task_id}")
    
    try:
        task_logger.info(f"开始执行Google Sheet任务: {task.name}")
        # ... 任务执行逻辑
        task_logger.info("任务执行完成")
    except Exception as e:
        task_logger.exception(f"执行任务失败: {str(e)}")
    finally:
        task_logger.info("任务执行器退出")
```

#### GoogleSheetService 集成
```python
def __init__(self, config: Dict[str, Any], task_id: str, event_queue=None, app=None):
    # ... 其他初始化
    # 创建任务专用日志记录器
    self.task_logger = get_task_logger(task_id, f"{__name__}.{task_id}")

def _execute_parameter_combination(self, index: int, combination: List, config_data: Dict[str, Any]) -> tuple:
    self.task_logger.step_info(index + 1, "N/A", f"执行参数组合: {combination}")
    # ... 执行逻辑
    self.task_logger.api_info("向Google Sheet写入参数", f"参数: {cell_updates}")
```

### 3. 新增API端点

#### 获取任务系统日志
```http
GET /api/tasks/{task_id}/system-logs
Query Parameters:
  - limit: int (默认200) - 限制返回的日志条数
  - level: string - 日志级别过滤 (info/warning/error)

Response:
{
  "status": "success",
  "logs": [
    {
      "timestamp": "2025-10-13T15:30:45.123000",
      "level": "info",
      "message": "[Task-a1b2c3d4] 开始执行Google Sheet任务",
      "source": "app.services.google_sheet_service",
      "task_id": "a1b2c3d4-5678-9abc-def0-123456789012"
    }
  ],
  "task_id": "a1b2c3d4-5678-9abc-def0-123456789012",
  "total_found": 45
}
```

#### 全局日志任务ID过滤
```http
GET /api/logs?task_id={task_id}
Query Parameters:
  - task_id: string - 任务ID过滤器
  - limit: int (默认100)
  - level: string - 日志级别过滤
  - search: string - 消息内容搜索
  - date: string - 日期过滤
```

## 📊 日志格式规范

### 日志前缀标准
- **任务标识**：`[Task-{任务ID前8位}]`
- **步骤信息**：`[Step {当前步骤}/{总步骤}]`
- **进度信息**：`[Progress {百分比}%]`
- **API调用**：`[API]` 或 `[API_ERROR]`

### 示例日志输出
```
2025-10-13 15:30:45,123 - app.services.task_manager - INFO - [Task-a1b2c3d4] 创建任务成功 - 名称: 股票参数校验, 类型: google_sheet, 配置项数量: 8
2025-10-13 15:30:45,234 - app.services.task_manager - INFO - [Task-a1b2c3d4] 开始启动任务 - 名称: 股票参数校验, 类型: google_sheet
2025-10-13 15:30:45,345 - app.services.task_manager - INFO - [Task-a1b2c3d4] 创建任务事件队列成功
2025-10-13 15:30:45,456 - app.services.task_manager - INFO - [Task-a1b2c3d4] 创建Google Sheet任务执行线程
2025-10-13 15:30:45,567 - app.services.task_manager - INFO - [Task-a1b2c3d4] 任务执行线程启动成功
2025-10-13 15:30:45,678 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 开始执行Google Sheet任务: 股票参数校验
2025-10-13 15:30:45,789 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 开始初始化Google Sheet连接
2025-10-13 15:30:46,123 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] Google Sheet连接初始化成功
2025-10-13 15:30:46,234 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 将执行 100 个参数组合
2025-10-13 15:30:46,345 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 任务将从第 1 个参数组合开始执行
2025-10-13 15:30:46,456 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [Step 1/100] 开始执行参数组合
2025-10-13 15:30:46,567 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 向Google Sheet写入参数: {'B6': 4, 'B7': 0.85}
2025-10-13 15:30:47,678 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [API] 发送股票模板参数数据 - stock_no: 000001
2025-10-13 15:30:47,789 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [API] 发送股票模板参数数据成功 - ID: 12345
```

## 🔍 使用指南

### 开发人员使用

#### 1. 在新模块中集成TaskLogger
```python
from app.utils.logger import get_task_logger

class YourService:
    def __init__(self, task_id):
        self.task_id = task_id
        self.task_logger = get_task_logger(task_id, f"{__name__}.{task_id}")
    
    def your_method(self):
        self.task_logger.info("开始执行业务逻辑")
        try:
            # 业务逻辑
            self.task_logger.step_info(1, 5, "执行第一步")
            # ...
        except Exception as e:
            self.task_logger.exception(f"执行失败: {str(e)}")
```

#### 2. API调用日志记录规范
```python
def call_external_api(self, data):
    try:
        self.task_logger.api_info("调用外部API", f"参数: {data}")
        result = self.api_client.call(data)
        self.task_logger.api_info("API调用成功", f"返回: {result}")
        return result
    except Exception as e:
        self.task_logger.api_error("API调用失败", str(e))
        raise
```

### 运维人员使用

#### 1. 任务问题排查
```bash
# 获取特定任务的所有日志
curl "http://localhost:5000/api/tasks/a1b2c3d4-5678-9abc-def0-123456789012/system-logs"

# 获取特定任务的错误日志
curl "http://localhost:5000/api/tasks/a1b2c3d4-5678-9abc-def0-123456789012/system-logs?level=error"

# 在全局日志中搜索特定任务
curl "http://localhost:5000/api/logs?task_id=a1b2c3d4-5678-9abc-def0-123456789012"
```

#### 2. 日志文件直接搜索
```bash
# 搜索特定任务的日志
grep "\[Task-a1b2c3d4\]" logs/app.log

# 搜索API调用错误
grep "\[API_ERROR\]" logs/app.log

# 搜索特定任务的步骤日志
grep -E "\[Task-a1b2c3d4\].*\[Step" logs/app.log
```

## 📈 性能影响分析

### 内存使用
- TaskLogger对象轻量级，每个任务约增加1-2KB内存
- 日志前缀处理对性能影响微乎其微
- 推荐在任务结束后及时清理TaskLogger引用

### 日志文件大小
- 每条日志增加约15-20个字符的前缀
- 对于大型任务，预计日志文件增长10-15%
- 建议配置合适的日志轮转策略

### API响应时间
- 新增API端点需要读取日志文件，响应时间取决于日志文件大小
- 建议对大型日志文件考虑异步处理
- 可以通过limit参数控制返回的日志数量

## 🔮 未来规划

### 短期计划 (1-2周)
1. 前端界面集成任务日志查看功能
2. 添加日志导出功能 (CSV/JSON格式)
3. 实现日志实时推送到前端
4. 添加日志级别统计图表

### 中期计划 (1个月)
1. 实现任务执行时间分析和性能监控
2. 添加任务性能监控仪表板
3. 实现日志告警功能（如错误率过高）
4. 添加日志数据压缩和归档

### 长期计划 (3个月)
1. 集成分布式日志收集系统（如ELK Stack）
2. 添加机器学习驱动的异常检测
3. 实现跨任务的关联分析
4. 提供日志数据的RESTful API

## 🐛 故障排除

### 常见问题

#### 1. 日志中没有看到任务ID前缀
**症状**：日志输出正常，但没有 `[Task-xxx]` 前缀
**原因**：可能使用了原来的logger而非TaskLogger
**解决**：检查代码中是否正确使用了 `get_task_logger(task_id)`

#### 2. API返回空的日志列表
**症状**：调用 `/api/tasks/{task_id}/system-logs` 返回空列表
**原因**：
- 任务ID不正确
- 日志文件权限问题
- 任务还没有生成日志
**解决**：
- 验证任务ID是否正确
- 检查日志文件是否存在且可读
- 确认任务是否已开始执行

#### 3. 日志搜索性能慢
**症状**：日志搜索API响应时间过长
**原因**：日志文件过大，需要全文扫描
**解决**：
- 使用limit参数限制返回数量
- 考虑实现日志索引
- 定期清理旧日志文件

### 调试技巧

#### 1. 验证TaskLogger是否正常工作
```python
# 在代码中添加调试信息
task_logger = get_task_logger("test-task-id")
task_logger.info("测试日志输出")
# 检查日志文件中是否有 [Task-test-tas] 前缀
```

#### 2. 检查日志文件权限
```bash
ls -la logs/app.log
# 确保应用有读写权限
```

#### 3. 监控日志文件增长
```bash
tail -f logs/app.log | grep "\[Task-"
# 实时监控任务相关日志
```

## 📚 参考文档

- [Python Logging Documentation](https://docs.python.org/3/library/logging.html)
- [Flask Logging Configuration](https://flask.palletsprojects.com/en/2.3.x/logging/)
- [SQLAlchemy Events](https://docs.sqlalchemy.org/en/20/core/event.html)

---

## 📞 支持联系

如果在使用过程中遇到问题，请：
1. 查看本文档的故障排除部分
2. 检查系统日志文件 `logs/app.log`
3. 提交详细的问题描述和错误日志

**更新记录**
- 2025-10-13: 初始版本，包含TaskLogger设计和API实现
- 待更新: 根据实际使用反馈持续优化
