# Google Task ä»»åŠ¡æ—¥å¿—ç³»ç»Ÿå‡çº§æŒ‡å—

> æ›´æ–°æ—¥æœŸï¼š2025-10-13
> ç‰ˆæœ¬ï¼šv2.0
> ä½œè€…ï¼šAI Assistant

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡å‡çº§å¯¹Google Taskä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ—¥å¿—ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼Œä¸»è¦ç›®æ ‡æ˜¯æå‡ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„å¯è§‚æµ‹æ€§å’Œé—®é¢˜æ’æŸ¥èƒ½åŠ›ã€‚é€šè¿‡å¼•å…¥ä»»åŠ¡ä¸“ç”¨æ—¥å¿—è®°å½•å™¨å’Œå¢å¼ºçš„æ—¥å¿—æœç´¢åŠŸèƒ½ï¼Œå¤§å¹…æå‡äº†å¼€å‘å’Œè¿ç»´æ•ˆç‡ã€‚

## ğŸ¯ å‡çº§ç›®æ ‡

### ä¸»è¦é—®é¢˜
1. **ä»»åŠ¡æ—¥å¿—éš¾ä»¥è·Ÿè¸ª**ï¼šå¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œæ—¶ï¼Œæ—¥å¿—æ··æ‚åœ¨ä¸€èµ·éš¾ä»¥åŒºåˆ†
2. **ç¼ºå°‘æ‰§è¡Œç»†èŠ‚**ï¼šæ— æ³•æ¸…æ™°äº†è§£ä»»åŠ¡çš„å…·ä½“æ‰§è¡Œæ­¥éª¤å’Œè¿›åº¦
3. **å¼‚å¸¸æ’æŸ¥å›°éš¾**ï¼šé”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ï¼Œç¼ºå°‘ä¸Šä¸‹æ–‡
4. **æ—¥å¿—æœç´¢ä¸ä¾¿**ï¼šæ— æ³•æŒ‰ä»»åŠ¡IDå¿«é€Ÿè¿‡æ»¤ç›¸å…³æ—¥å¿—

### è§£å†³æ–¹æ¡ˆ
1. **ä»»åŠ¡IDæ ‡è¯†**ï¼šæ‰€æœ‰ä»»åŠ¡ç›¸å…³æ—¥å¿—è‡ªåŠ¨æ·»åŠ ä»»åŠ¡IDå‰ç¼€
2. **åˆ†ç±»æ—¥å¿—è®°å½•**ï¼šæä¾›æ­¥éª¤ã€è¿›åº¦ã€APIè°ƒç”¨ç­‰ä¸“ç”¨æ—¥å¿—æ–¹æ³•
3. **å¢å¼ºå¼‚å¸¸å¤„ç†**ï¼šæ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¸Šä¸‹æ–‡å’Œå †æ ˆä¿¡æ¯
4. **ä¸“ç”¨æœç´¢API**ï¼šæä¾›æŒ‰ä»»åŠ¡IDè¿‡æ»¤æ—¥å¿—çš„APIç«¯ç‚¹

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. TaskLogger ç±»è®¾è®¡

#### æ ¸å¿ƒç±»ç»“æ„
```python
class TaskLogger:
    """ä»»åŠ¡ä¸“ç”¨æ—¥å¿—è®°å½•å™¨ï¼Œè‡ªåŠ¨æ·»åŠ ä»»åŠ¡IDå‰ç¼€"""
    
    def __init__(self, task_id: str, logger_name: str = None):
        self.task_id = task_id
        self.logger = get_logger(logger_name or __name__)
        self.prefix = f"[Task-{task_id[:8]}]"  # ä½¿ç”¨ä»»åŠ¡IDå‰8ä½ä½œä¸ºå‰ç¼€
    
    def _format_message(self, message: str) -> str:
        """æ ¼å¼åŒ–æ¶ˆæ¯ï¼Œæ·»åŠ ä»»åŠ¡IDå‰ç¼€"""
        return f"{self.prefix} {message}"
```

#### ä¸“ç”¨æ—¥å¿—æ–¹æ³•
```python
# åŸºç¡€æ—¥å¿—æ–¹æ³•
task_logger.info("å¼€å§‹æ‰§è¡Œä»»åŠ¡")
task_logger.warning("æ£€æµ‹åˆ°æ½œåœ¨é—®é¢˜")  
task_logger.error("æ‰§è¡Œå‡ºç°é”™è¯¯")
task_logger.exception("æ•è·å¼‚å¸¸")

# ä¸“ç”¨æ—¥å¿—æ–¹æ³•
task_logger.step_info(1, 100, "å¼€å§‹æ‰§è¡Œå‚æ•°ç»„åˆ")
task_logger.progress_info(25.5, "å¤„ç†ä¸­")
task_logger.api_info("å‘é€æ•°æ®", "stock_no: 000001")
task_logger.api_error("è·å–æ•°æ®", "è¿æ¥è¶…æ—¶")
```

### 2. é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

#### TaskManager é›†æˆ
```python
def _execute_google_sheet_task(self, task_id: str, app):
    # åˆ›å»ºä»»åŠ¡ä¸“ç”¨æ—¥å¿—è®°å½•å™¨
    task_logger = get_task_logger(task_id, f"{__name__}.{task_id}")
    
    try:
        task_logger.info(f"å¼€å§‹æ‰§è¡ŒGoogle Sheetä»»åŠ¡: {task.name}")
        # ... ä»»åŠ¡æ‰§è¡Œé€»è¾‘
        task_logger.info("ä»»åŠ¡æ‰§è¡Œå®Œæˆ")
    except Exception as e:
        task_logger.exception(f"æ‰§è¡Œä»»åŠ¡å¤±è´¥: {str(e)}")
    finally:
        task_logger.info("ä»»åŠ¡æ‰§è¡Œå™¨é€€å‡º")
```

#### GoogleSheetService é›†æˆ
```python
def __init__(self, config: Dict[str, Any], task_id: str, event_queue=None, app=None):
    # ... å…¶ä»–åˆå§‹åŒ–
    # åˆ›å»ºä»»åŠ¡ä¸“ç”¨æ—¥å¿—è®°å½•å™¨
    self.task_logger = get_task_logger(task_id, f"{__name__}.{task_id}")

def _execute_parameter_combination(self, index: int, combination: List, config_data: Dict[str, Any]) -> tuple:
    self.task_logger.step_info(index + 1, "N/A", f"æ‰§è¡Œå‚æ•°ç»„åˆ: {combination}")
    # ... æ‰§è¡Œé€»è¾‘
    self.task_logger.api_info("å‘Google Sheetå†™å…¥å‚æ•°", f"å‚æ•°: {cell_updates}")
```

### 3. æ–°å¢APIç«¯ç‚¹

#### è·å–ä»»åŠ¡ç³»ç»Ÿæ—¥å¿—
```http
GET /api/tasks/{task_id}/system-logs
Query Parameters:
  - limit: int (é»˜è®¤200) - é™åˆ¶è¿”å›çš„æ—¥å¿—æ¡æ•°
  - level: string - æ—¥å¿—çº§åˆ«è¿‡æ»¤ (info/warning/error)

Response:
{
  "status": "success",
  "logs": [
    {
      "timestamp": "2025-10-13T15:30:45.123000",
      "level": "info",
      "message": "[Task-a1b2c3d4] å¼€å§‹æ‰§è¡ŒGoogle Sheetä»»åŠ¡",
      "source": "app.services.google_sheet_service",
      "task_id": "a1b2c3d4-5678-9abc-def0-123456789012"
    }
  ],
  "task_id": "a1b2c3d4-5678-9abc-def0-123456789012",
  "total_found": 45
}
```

#### å…¨å±€æ—¥å¿—ä»»åŠ¡IDè¿‡æ»¤
```http
GET /api/logs?task_id={task_id}
Query Parameters:
  - task_id: string - ä»»åŠ¡IDè¿‡æ»¤å™¨
  - limit: int (é»˜è®¤100)
  - level: string - æ—¥å¿—çº§åˆ«è¿‡æ»¤
  - search: string - æ¶ˆæ¯å†…å®¹æœç´¢
  - date: string - æ—¥æœŸè¿‡æ»¤
```

## ğŸ“Š æ—¥å¿—æ ¼å¼è§„èŒƒ

### æ—¥å¿—å‰ç¼€æ ‡å‡†
- **ä»»åŠ¡æ ‡è¯†**ï¼š`[Task-{ä»»åŠ¡IDå‰8ä½}]`
- **æ­¥éª¤ä¿¡æ¯**ï¼š`[Step {å½“å‰æ­¥éª¤}/{æ€»æ­¥éª¤}]`
- **è¿›åº¦ä¿¡æ¯**ï¼š`[Progress {ç™¾åˆ†æ¯”}%]`
- **APIè°ƒç”¨**ï¼š`[API]` æˆ– `[API_ERROR]`

### ç¤ºä¾‹æ—¥å¿—è¾“å‡º
```
2025-10-13 15:30:45,123 - app.services.task_manager - INFO - [Task-a1b2c3d4] åˆ›å»ºä»»åŠ¡æˆåŠŸ - åç§°: è‚¡ç¥¨å‚æ•°æ ¡éªŒ, ç±»å‹: google_sheet, é…ç½®é¡¹æ•°é‡: 8
2025-10-13 15:30:45,234 - app.services.task_manager - INFO - [Task-a1b2c3d4] å¼€å§‹å¯åŠ¨ä»»åŠ¡ - åç§°: è‚¡ç¥¨å‚æ•°æ ¡éªŒ, ç±»å‹: google_sheet
2025-10-13 15:30:45,345 - app.services.task_manager - INFO - [Task-a1b2c3d4] åˆ›å»ºä»»åŠ¡äº‹ä»¶é˜Ÿåˆ—æˆåŠŸ
2025-10-13 15:30:45,456 - app.services.task_manager - INFO - [Task-a1b2c3d4] åˆ›å»ºGoogle Sheetä»»åŠ¡æ‰§è¡Œçº¿ç¨‹
2025-10-13 15:30:45,567 - app.services.task_manager - INFO - [Task-a1b2c3d4] ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹å¯åŠ¨æˆåŠŸ
2025-10-13 15:30:45,678 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] å¼€å§‹æ‰§è¡ŒGoogle Sheetä»»åŠ¡: è‚¡ç¥¨å‚æ•°æ ¡éªŒ
2025-10-13 15:30:45,789 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] å¼€å§‹åˆå§‹åŒ–Google Sheetè¿æ¥
2025-10-13 15:30:46,123 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] Google Sheetè¿æ¥åˆå§‹åŒ–æˆåŠŸ
2025-10-13 15:30:46,234 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] å°†æ‰§è¡Œ 100 ä¸ªå‚æ•°ç»„åˆ
2025-10-13 15:30:46,345 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] ä»»åŠ¡å°†ä»ç¬¬ 1 ä¸ªå‚æ•°ç»„åˆå¼€å§‹æ‰§è¡Œ
2025-10-13 15:30:46,456 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [Step 1/100] å¼€å§‹æ‰§è¡Œå‚æ•°ç»„åˆ
2025-10-13 15:30:46,567 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] å‘Google Sheetå†™å…¥å‚æ•°: {'B6': 4, 'B7': 0.85}
2025-10-13 15:30:47,678 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [API] å‘é€è‚¡ç¥¨æ¨¡æ¿å‚æ•°æ•°æ® - stock_no: 000001
2025-10-13 15:30:47,789 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [API] å‘é€è‚¡ç¥¨æ¨¡æ¿å‚æ•°æ•°æ®æˆåŠŸ - ID: 12345
```

## ğŸ” ä½¿ç”¨æŒ‡å—

### å¼€å‘äººå‘˜ä½¿ç”¨

#### 1. åœ¨æ–°æ¨¡å—ä¸­é›†æˆTaskLogger
```python
from app.utils.logger import get_task_logger

class YourService:
    def __init__(self, task_id):
        self.task_id = task_id
        self.task_logger = get_task_logger(task_id, f"{__name__}.{task_id}")
    
    def your_method(self):
        self.task_logger.info("å¼€å§‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘")
        try:
            # ä¸šåŠ¡é€»è¾‘
            self.task_logger.step_info(1, 5, "æ‰§è¡Œç¬¬ä¸€æ­¥")
            # ...
        except Exception as e:
            self.task_logger.exception(f"æ‰§è¡Œå¤±è´¥: {str(e)}")
```

#### 2. APIè°ƒç”¨æ—¥å¿—è®°å½•è§„èŒƒ
```python
def call_external_api(self, data):
    try:
        self.task_logger.api_info("è°ƒç”¨å¤–éƒ¨API", f"å‚æ•°: {data}")
        result = self.api_client.call(data)
        self.task_logger.api_info("APIè°ƒç”¨æˆåŠŸ", f"è¿”å›: {result}")
        return result
    except Exception as e:
        self.task_logger.api_error("APIè°ƒç”¨å¤±è´¥", str(e))
        raise
```

### è¿ç»´äººå‘˜ä½¿ç”¨

#### 1. ä»»åŠ¡é—®é¢˜æ’æŸ¥
```bash
# è·å–ç‰¹å®šä»»åŠ¡çš„æ‰€æœ‰æ—¥å¿—
curl "http://localhost:5000/api/tasks/a1b2c3d4-5678-9abc-def0-123456789012/system-logs"

# è·å–ç‰¹å®šä»»åŠ¡çš„é”™è¯¯æ—¥å¿—
curl "http://localhost:5000/api/tasks/a1b2c3d4-5678-9abc-def0-123456789012/system-logs?level=error"

# åœ¨å…¨å±€æ—¥å¿—ä¸­æœç´¢ç‰¹å®šä»»åŠ¡
curl "http://localhost:5000/api/logs?task_id=a1b2c3d4-5678-9abc-def0-123456789012"
```

#### 2. æ—¥å¿—æ–‡ä»¶ç›´æ¥æœç´¢
```bash
# æœç´¢ç‰¹å®šä»»åŠ¡çš„æ—¥å¿—
grep "\[Task-a1b2c3d4\]" logs/app.log

# æœç´¢APIè°ƒç”¨é”™è¯¯
grep "\[API_ERROR\]" logs/app.log

# æœç´¢ç‰¹å®šä»»åŠ¡çš„æ­¥éª¤æ—¥å¿—
grep -E "\[Task-a1b2c3d4\].*\[Step" logs/app.log
```

## ğŸ“ˆ æ€§èƒ½å½±å“åˆ†æ

### å†…å­˜ä½¿ç”¨
- TaskLoggerå¯¹è±¡è½»é‡çº§ï¼Œæ¯ä¸ªä»»åŠ¡çº¦å¢åŠ 1-2KBå†…å­˜
- æ—¥å¿—å‰ç¼€å¤„ç†å¯¹æ€§èƒ½å½±å“å¾®ä¹å…¶å¾®
- æ¨èåœ¨ä»»åŠ¡ç»“æŸååŠæ—¶æ¸…ç†TaskLoggerå¼•ç”¨

### æ—¥å¿—æ–‡ä»¶å¤§å°
- æ¯æ¡æ—¥å¿—å¢åŠ çº¦15-20ä¸ªå­—ç¬¦çš„å‰ç¼€
- å¯¹äºå¤§å‹ä»»åŠ¡ï¼Œé¢„è®¡æ—¥å¿—æ–‡ä»¶å¢é•¿10-15%
- å»ºè®®é…ç½®åˆé€‚çš„æ—¥å¿—è½®è½¬ç­–ç•¥

### APIå“åº”æ—¶é—´
- æ–°å¢APIç«¯ç‚¹éœ€è¦è¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œå“åº”æ—¶é—´å–å†³äºæ—¥å¿—æ–‡ä»¶å¤§å°
- å»ºè®®å¯¹å¤§å‹æ—¥å¿—æ–‡ä»¶è€ƒè™‘å¼‚æ­¥å¤„ç†
- å¯ä»¥é€šè¿‡limitå‚æ•°æ§åˆ¶è¿”å›çš„æ—¥å¿—æ•°é‡

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸè®¡åˆ’ (1-2å‘¨)
1. å‰ç«¯ç•Œé¢é›†æˆä»»åŠ¡æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½
2. æ·»åŠ æ—¥å¿—å¯¼å‡ºåŠŸèƒ½ (CSV/JSONæ ¼å¼)
3. å®ç°æ—¥å¿—å®æ—¶æ¨é€åˆ°å‰ç«¯
4. æ·»åŠ æ—¥å¿—çº§åˆ«ç»Ÿè®¡å›¾è¡¨

### ä¸­æœŸè®¡åˆ’ (1ä¸ªæœˆ)
1. å®ç°ä»»åŠ¡æ‰§è¡Œæ—¶é—´åˆ†æå’Œæ€§èƒ½ç›‘æ§
2. æ·»åŠ ä»»åŠ¡æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿
3. å®ç°æ—¥å¿—å‘Šè­¦åŠŸèƒ½ï¼ˆå¦‚é”™è¯¯ç‡è¿‡é«˜ï¼‰
4. æ·»åŠ æ—¥å¿—æ•°æ®å‹ç¼©å’Œå½’æ¡£

### é•¿æœŸè®¡åˆ’ (3ä¸ªæœˆ)
1. é›†æˆåˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼ˆå¦‚ELK Stackï¼‰
2. æ·»åŠ æœºå™¨å­¦ä¹ é©±åŠ¨çš„å¼‚å¸¸æ£€æµ‹
3. å®ç°è·¨ä»»åŠ¡çš„å…³è”åˆ†æ
4. æä¾›æ—¥å¿—æ•°æ®çš„RESTful API

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ—¥å¿—ä¸­æ²¡æœ‰çœ‹åˆ°ä»»åŠ¡IDå‰ç¼€
**ç—‡çŠ¶**ï¼šæ—¥å¿—è¾“å‡ºæ­£å¸¸ï¼Œä½†æ²¡æœ‰ `[Task-xxx]` å‰ç¼€
**åŸå› **ï¼šå¯èƒ½ä½¿ç”¨äº†åŸæ¥çš„loggerè€ŒéTaskLogger
**è§£å†³**ï¼šæ£€æŸ¥ä»£ç ä¸­æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº† `get_task_logger(task_id)`

#### 2. APIè¿”å›ç©ºçš„æ—¥å¿—åˆ—è¡¨
**ç—‡çŠ¶**ï¼šè°ƒç”¨ `/api/tasks/{task_id}/system-logs` è¿”å›ç©ºåˆ—è¡¨
**åŸå› **ï¼š
- ä»»åŠ¡IDä¸æ­£ç¡®
- æ—¥å¿—æ–‡ä»¶æƒé™é—®é¢˜
- ä»»åŠ¡è¿˜æ²¡æœ‰ç”Ÿæˆæ—¥å¿—
**è§£å†³**ï¼š
- éªŒè¯ä»»åŠ¡IDæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»
- ç¡®è®¤ä»»åŠ¡æ˜¯å¦å·²å¼€å§‹æ‰§è¡Œ

#### 3. æ—¥å¿—æœç´¢æ€§èƒ½æ…¢
**ç—‡çŠ¶**ï¼šæ—¥å¿—æœç´¢APIå“åº”æ—¶é—´è¿‡é•¿
**åŸå› **ï¼šæ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼Œéœ€è¦å…¨æ–‡æ‰«æ
**è§£å†³**ï¼š
- ä½¿ç”¨limitå‚æ•°é™åˆ¶è¿”å›æ•°é‡
- è€ƒè™‘å®ç°æ—¥å¿—ç´¢å¼•
- å®šæœŸæ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶

### è°ƒè¯•æŠ€å·§

#### 1. éªŒè¯TaskLoggeræ˜¯å¦æ­£å¸¸å·¥ä½œ
```python
# åœ¨ä»£ç ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
task_logger = get_task_logger("test-task-id")
task_logger.info("æµ‹è¯•æ—¥å¿—è¾“å‡º")
# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ [Task-test-tas] å‰ç¼€
```

#### 2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æƒé™
```bash
ls -la logs/app.log
# ç¡®ä¿åº”ç”¨æœ‰è¯»å†™æƒé™
```

#### 3. ç›‘æ§æ—¥å¿—æ–‡ä»¶å¢é•¿
```bash
tail -f logs/app.log | grep "\[Task-"
# å®æ—¶ç›‘æ§ä»»åŠ¡ç›¸å…³æ—¥å¿—
```

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Python Logging Documentation](https://docs.python.org/3/library/logging.html)
- [Flask Logging Configuration](https://flask.palletsprojects.com/en/2.3.x/logging/)
- [SQLAlchemy Events](https://docs.sqlalchemy.org/en/20/core/event.html)

---

## ğŸ“ æ”¯æŒè”ç³»

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ `logs/app.log`
3. æäº¤è¯¦ç»†çš„é—®é¢˜æè¿°å’Œé”™è¯¯æ—¥å¿—

**æ›´æ–°è®°å½•**
- 2025-10-13: åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«TaskLoggerè®¾è®¡å’ŒAPIå®ç°
- å¾…æ›´æ–°: æ ¹æ®å®é™…ä½¿ç”¨åé¦ˆæŒç»­ä¼˜åŒ–
