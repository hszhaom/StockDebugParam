# GoogleSheetService 统一日志接口使用说明

## 📋 概述

已成功将 `GoogleSheetService` 中的所有日志调用统一为单一接口，确保所有线程内的执行日志都带有任务ID前缀，便于日志查询和问题排查。

## 🔧 统一日志接口设计

### 核心日志方法 `_log()`

```python
def _log(self, level: str, message: str, log_type: str = 'general', **kwargs):
    """
    统一的日志记录接口
    
    Args:
        level: 日志级别 ('info', 'warning', 'error')
        message: 日志消息
        log_type: 日志类型 ('general', 'step', 'progress', 'api', 'api_error')
        **kwargs: 额外参数，用于特定类型的日志
    """
```

### 功能特点

1. **三重日志记录**：
   - 系统日志（带任务ID前缀）
   - 数据库日志（TaskLog表）
   - 前端推送（SSE实时更新）

2. **多种日志类型**：
   - `general` - 普通日志
   - `step` - 步骤日志：`[Step 1/100] 消息`
   - `progress` - 进度日志：`[Progress 25.5%] 消息`
   - `api` - API调用日志：`[API] 操作 - 详情`
   - `api_error` - API错误日志：`[API_ERROR] 操作 - 错误`

## 🎯 便捷方法

### 基础日志方法
```python
self._log_info("开始执行任务")           # INFO级别
self._log_warning("检测到潜在问题")       # WARNING级别
self._log_error("执行出现错误")           # ERROR级别
```

### 专用日志方法
```python
# 步骤日志
self._log_step(1, 100, "开始执行参数组合")
# 输出: [Task-a1b2c3d4] [Step 1/100] 开始执行参数组合

# 进度日志
self._log_progress(25.5, "处理中")
# 输出: [Task-a1b2c3d4] [Progress 25.5%] 处理中

# API调用日志
self._log_api("发送数据", "stock_no: 000001")
# 输出: [Task-a1b2c3d4] [API] 发送数据 - stock_no: 000001

# API错误日志
self._log_api_error("获取数据", "连接超时")
# 输出: [Task-a1b2c3d4] [API_ERROR] 获取数据 - 连接超时
```

## 📊 实际日志输出示例

### 任务执行完整流程日志
```
2025-10-13 15:30:45,123 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 开始执行Google Sheet任务
2025-10-13 15:30:45,234 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 开始初始化Google Sheet连接
2025-10-13 15:30:45,345 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 连接参数 - Spreadsheet ID: 1abc..., Sheet: data, Token: data/token.json
2025-10-13 15:30:45,456 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] Google Sheet连接初始化成功
2025-10-13 15:30:45,567 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 将执行 100 个参数组合
2025-10-13 15:30:45,678 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 任务将从第 1 个参数组合开始执行
2025-10-13 15:30:45,789 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [Step 1/100] 开始执行参数组合
2025-10-13 15:30:46,123 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 向Google Sheet写入参数: {'B6': 4, 'B7': 0.85}
2025-10-13 15:30:46,234 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 第 1 次检查执行状态...
2025-10-13 15:31:15,345 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 所有参数执行完成，获取结果...
2025-10-13 15:31:15,456 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 执行结果: {'B6': 4, 'B7': 0.85, 'I15': 0.125, ...}
2025-10-13 15:31:15,567 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 第 1 个参数组合执行成功，{'B6': 4, ...}
2025-10-13 15:31:15,678 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [API] 发送股票模板参数数据 - stock_no: 000001
2025-10-13 15:31:15,789 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] [API] 发送股票模板参数数据成功 - ID: 12345
2025-10-13 15:31:15,890 - app.services.google_sheet_service - INFO - [Task-a1b2c3d4] 第 1 个参数组合执行完成，成功: 1, 失败: 0
```

### 错误处理日志示例
```
2025-10-13 15:32:10,123 - app.services.google_sheet_service - ERROR - [Task-a1b2c3d4] Google Sheet连接未建立
2025-10-13 15:32:10,234 - app.services.google_sheet_service - ERROR - [Task-a1b2c3d4] [API_ERROR] 发送股票模板参数数据 - 连接超时
2025-10-13 15:32:10,345 - app.services.google_sheet_service - WARNING - [Task-a1b2c3d4] 执行超时，未在规定时间内完成
2025-10-13 15:32:10,456 - app.services.google_sheet_service - WARNING - [Task-a1b2c3d4] 任务已被取消，停止执行
```

## 🔍 日志查询方法

### 1. 通过API查询特定任务日志
```bash
# 获取特定任务的所有系统日志
GET /api/tasks/a1b2c3d4-5678-9abc-def0-123456789012/system-logs

# 获取特定任务的错误日志
GET /api/tasks/a1b2c3d4-5678-9abc-def0-123456789012/system-logs?level=error
```

### 2. 在全局日志中搜索
```bash
# 在全局日志中搜索特定任务
GET /api/logs?task_id=a1b2c3d4-5678-9abc-def0-123456789012
```

### 3. 直接搜索日志文件
```bash
# 搜索特定任务的所有日志
grep "\[Task-a1b2c3d4\]" logs/app.log

# 搜索特定任务的API调用
grep -E "\[Task-a1b2c3d4\].*\[API\]" logs/app.log

# 搜索特定任务的错误日志
grep -E "\[Task-a1b2c3d4\].*ERROR" logs/app.log

# 搜索特定任务的步骤日志
grep -E "\[Task-a1b2c3d4\].*\[Step" logs/app.log
```

## ✅ 优化效果

### 改进前的问题
1. 日志格式不统一，难以跟踪特定任务
2. 日志记录分散在多个方法中，维护困难
3. 缺少任务ID标识，多任务并发时日志混杂

### 改进后的优势
1. **统一格式**：所有任务日志都带有 `[Task-a1b2c3d4]` 前缀
2. **分类清晰**：步骤、进度、API调用等都有专门的标识
3. **易于维护**：所有日志调用统一为一个接口
4. **便于查询**：支持多种查询方式，快速定位问题
5. **三重保障**：系统日志、数据库、前端同步记录

### 性能优化
1. 异常处理优化，避免日志记录失败影响主流程
2. 条件判断优化，减少不必要的字符串格式化
3. 统一接口减少代码重复，提高执行效率

## 📈 未来扩展

### 计划功能
1. 添加日志级别的动态调整
2. 支持日志采样，减少高频日志的性能影响
3. 集成分布式日志收集系统
4. 添加日志数据的分析和可视化

### 使用建议
1. 在任务关键节点使用步骤日志 `_log_step()`
2. 在长时间运行的操作中使用进度日志 `_log_progress()`
3. 所有外部API调用都使用 `_log_api()` 和 `_log_api_error()`
4. 避免在高频循环中记录过多日志，影响性能
5. 重要的业务逻辑变更都应该有对应的日志记录

---

**更新日期**: 2025-10-13  
**版本**: v1.0  
**状态**: 已完成并测试通过
