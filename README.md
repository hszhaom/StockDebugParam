# 谷歌参数批量校验系统

这是一个用于批量执行Google Sheet参数组合并校验结果的Web应用。

## 功能特性

1. **参数配置**：支持配置6个参数列表，系统会自动生成所有可能的参数组合
2. **Google Sheet集成**：自动将参数写入指定的Google Sheet位置
3. **多任务执行**：支持同时执行多个任务，互不干扰
4. **进度保持**：任务执行进度会自动保存，即使应用重启也能继续执行
5. **实时日志**：提供实时执行日志查看
6. **结果检查**：定时检查执行结果并获取返回值
7. **任务管理**：可以查看、取消正在执行的任务
8. **多页面设计**：首页、创建任务页、任务详情页分离，操作更清晰
9. **灵活配置**：支持通过ID或URL指定电子表格，工作表名称下拉选择，Token认证方式灵活
10. **参数组合预览**：创建任务时显示参数组合数量
11. **执行确认机制**：第一次执行完成后通过SSE返回结果到前端确认，确认后继续执行
12. **模块化设计**：任务执行逻辑独立封装，便于维护和扩展

## 系统要求

- Python 3.6+
- Flask
- gspread
- google-auth
- httpx

## 安装依赖

```bash
pip install flask gspread google-auth httpx
```

## 配置说明

### 1. Google认证配置
- 可以通过文件路径指定Token文件
- 也可以直接传入JSON字符串

### 2. 系统配置
- 电子表格ID：可以是ID或完整URL
- 工作表名称：提供常用选项的下拉框选择
- Token认证：支持文件路径和JSON字符串两种方式

## 使用方法

1. 启动应用：
```bash
python app.py
```

2. 访问应用：
- 首页：http://localhost:5000
- 创建任务页面：http://localhost:5000/create
- 配置页面：http://localhost:5000/config
- 任务详情页面：http://localhost:5000/detail?task_id=[任务ID]

3. 在创建任务页面配置Google Sheet相关信息

4. 输入6个参数的JSON数组格式列表

5. 点击"创建任务并执行"按钮创建新任务

6. 可以在首页查看所有任务的执行状态

## 目录结构

```
.
├── app.py                 # 主应用文件
├── googlesheet.py         # Google Sheet操作模块
├── logger.py              # 日志模块
├── config/
│   └── config.json        # 系统配置文件
├── data/
│   ├── token.json         # Google认证文件（需要手动添加）
│   └── tasks.json         # 任务状态文件（自动生成）
├── tasks/
│   └── google_sheet_task.py # Google Sheet任务执行器
├── templates/
│   ├── base.html          # 基础模板
│   ├── index.html         # 首页
│   ├── create.html        # 创建任务页面
│   ├── detail.html        # 任务详情页面
│   └── config.html        # 配置页面
└── static/                # 静态文件目录
```

## 页面功能说明

### 首页 (/)
- 显示任务统计信息（总任务数、已完成、执行中、执行出错）
- 显示最近任务列表
- 提供创建新任务的按钮

### 创建任务页面 (/create)
- 专门用于创建新任务
- 支持通过ID或URL指定电子表格
- 工作表名称提供下拉框选择（data, data-1Y, data-3Y, data-7Y等）
- Token认证支持文件路径和JSON字符串两种方式
- 包含6个参数输入框
- 显示参数组合数量预览
- 通过SSE实时接收任务状态和确认请求
- 第一次执行完成后显示确认模态框
- 确认后继续执行剩余参数组合

### 任务详情页面 (/detail?task_id=[任务ID])
- 显示任务详细信息（状态、进度、时间等）
- 显示任务参数信息
- 显示任务执行日志
- 可以取消正在执行的任务

### 配置页面 (/config)
- 配置系统默认的Google Sheet连接信息

## 多任务执行说明

1. 系统支持同时执行多个任务，每个任务独立运行
2. 任务状态会自动保存到 `data/tasks.json` 文件中
3. 即使应用重启，未完成的任务也会继续执行
4. 可以随时取消正在执行的任务
5. 每个任务都有独立的日志记录

## 执行确认机制

1. 系统会在第一次执行完成后通过SSE发送结果到前端
2. 前端会显示确认模态框，展示第一次执行的参数和结果
3. 用户确认后继续执行后续参数组合
4. 用户拒绝或超时则停止执行
5. 通过任务状态模态框实时查看执行进度

## 模块化设计

### Google Sheet任务执行器 (tasks/google_sheet_task.py)
- 独立封装了Google Sheet任务的执行逻辑
- 负责参数组合生成、执行、结果检查等核心功能
- 通过SSE与前端进行实时通信
- 实现了第一次执行确认机制

### 主应用 (app.py)
- 负责Web路由、API接口、任务调度等
- 与任务执行器解耦，便于维护和扩展

## 注意事项

1. 确保Google Sheet的认证配置正确
2. 系统会每分钟检查一次执行结果，最多等待60分钟
3. 任务执行过程中不要删除 `data/tasks.json` 文件
4. 如果需要清理所有任务记录，可以删除 `data/tasks.json` 文件